<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì¶ Warehouse QR Check</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  color: #1e293b;
  padding: 20px;
  min-height: 100vh;
}
.header {
  position: fixed; top: 0; left: 0; width: 100%;
  background: #1e3a8a; color: white;
  text-align: center; padding: 14px 0;
  font-weight: 600; font-size: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 100;
}
.container {
  margin-top: 80px; background: white;
  border-radius: 12px; padding: 24px;
  max-width: 480px; margin-inline: auto;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.compact-row { display: flex; justify-content: center; gap: 54px; margin-bottom: 16px; }
.compact-row > div { width: 60%; display: flex; flex-direction: column; }
.compact-row label { font-weight: 600; margin-bottom: 4px; font-size: 13.5px; }
.compact-row input {
  width: 100%; padding: 5px 6px; font-size: 13.5px;
  border: 1.5px solid #cbd5e1; border-radius: 6px; height: 30px;
}
.form-row { display: flex; flex-direction: column; margin-bottom: 14px; }
.form-row label { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
.form-row input {
  width: 100%; padding: 5px 6px; font-size: 14px;
  border: 1.5px solid #cbd5e1; border-radius: 6px; height: 32px;
}
.readonly { background: #f1f5f9; }
.btn {
  border: none; border-radius: 8px; padding: 12px;
  font-weight: 600; color: white; background: #2563eb;
  width: 100%; cursor: pointer; font-size: 17px;
}
.btn:hover { background: #1d4ed8; }
.btn-scan {
  background: #059669; color: white; width: 100%;
  font-size: 18px; padding: 14px; border-radius: 10px;
  font-weight: 600; display: flex; align-items: center;
  justify-content: center; gap: 10px; border: 1.5px solid #047857;
}
.btn-scan svg { width: 22px; height: 22px; fill: white; }
.btn-scan:hover { background: #047857; }
hr { border: none; border-top: 1px solid #e2e8f0; margin: 20px 0; }

/* Package layout */
.package-box { display: flex; align-items: center; justify-content: center; gap: 6px; }
.pkg-input {
  text-align: center;
  font-size: 13.5px;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  height: 30px;
  padding: 2px;
}
.pkg-input.a { width: 60px; }
.pkg-input.b { width: 60px; }
.pkg-input.c { width: 80px; }

/* Button Row */
.button-row {
  display: flex;
  gap: 8px;
  margin-top: 15px;
}
.btn-add {
  width: 30%;
  background: #10b981;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 20px;
  color: white;
  cursor: pointer;
}
.btn-add:hover { background: #059669; }
.btn-save { width: 70%; }

/* Scanner Overlay */
#scanner-view {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #000; z-index: 200;
}
#scanner-container {
  width: 100%; height: 100%; position: relative;
  overflow: hidden; display: flex; justify-content: center; align-items: center;
}
video { object-fit: cover; width: 100%; height: 100%; }
.focus-box {
  position: absolute; top: 50%; left: 50%;
  width: 250px; height: 250px;
  transform: translate(-50%, -50%);
  border: 2px solid #00ff00;
  border-radius: 10px;
  z-index: 210;
  box-shadow: 0 0 0 2000px rgba(0,0,0,0.6);
}
.scan-text {
  position: absolute; bottom: 16%; width: 100%;
  text-align: center; color: #00ff00;
  font-size: 17px; font-weight: 600;
  text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  z-index: 211;
}
.btn-close {
  position: absolute; bottom: 30px; left: 50%;
  transform: translateX(-50%);
  background: #ef4444; border: none;
  border-radius: 50%; color: white;
  width: 60px; height: 60px; font-size: 28px;
  z-index: 212;
}
</style>
</head>

<body>
<div class="header">üì¶ RMT Warehouse Check Stock</div>

<div class="container" id="main-view">
  <button class="btn-scan" onclick="startScanner()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M3 3h8v8H3V3m2 2v4h4V5H5m6 6h2v2h-2v-2m0 4h2v2h-2v-2m4-4h2v2h-2v-2m0 4h2v2h-2v-2m-4 4h2v2h-2v-2m4 0h2v2h-2v-2M3 13h8v8H3v-8m2 2v4h4v-4H5m10-12h6v6h-6V3m2 2v2h2V5h-2m0 4h2v2h-2V9m0 4h6v6h-6v-6m2 2v2h2v-2h-2Z" />
    </svg> Scan QR
  </button>

  <hr>

  <!-- Static Info -->
  <div class="compact-row">
    <div><label>Customer</label><input id="customer" class="readonly" readonly></div>
    <div><label>File</label><input id="file" class="readonly" readonly></div>
  </div>

  <div class="compact-row">
    <div><label>Lot</label><input id="lot" class="readonly" readonly></div>
    <div><label>Q'ty</label><input id="sumQty" class="readonly" readonly></div>
  </div>

  <div class="form-row"><label>Rack</label><input id="rack" class="readonly" readonly></div>
  <div class="form-row"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</label><input id="scannerName" class="readonly" readonly></div>

  <hr>

  <!-- Dynamic Zone -->
  <div id="rackZone">
    <div class="rack-set">
      <div class="form-row"><label>Act Rack</label><input class="actRack" placeholder="‡πÄ‡∏ä‡πà‡∏ô R01-A"></div>
      <div class="compact-row">
        <div>
          <label>Package</label>
          <div class="package-box">
            <input type="number" class="pkg-input a"> √ó
            <input type="number" class="pkg-input b"> +
            <input type="number" class="pkg-input c">
          </div>
        </div>
        <div>
          <label>Act Q'ty</label>
          <input class="actQty readonly" readonly>
        </div>
      </div>
    </div>
  </div>

  <!-- Button Row -->
  <div class="button-row">
    <button class="btn-add" onclick="addRackSet()">Ôºã</button>
    <button class="btn btn-save" onclick="submitData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <p style="text-align:center;margin-top:12px;font-size:12px;color:#64748b;">
    ¬© 2025 Resonac Materials (Thailand) Co., Ltd.
  </p>
</div>

<!-- Scanner View -->
<div id="scanner-view">
  <div id="scanner-container"></div>
  <div class="focus-box"></div>
  <div class="scan-text">‡πÅ‡∏ï‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û QR</div>
  <button class="btn-close" onclick="stopScanner()">‚úï</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
let codeReader, videoElem, scanning = false;

async function startScanner() {
  document.getElementById("main-view").style.display = "none";
  document.getElementById("scanner-view").style.display = "block";

  codeReader = new ZXing.BrowserMultiFormatReader();
  videoElem = document.createElement("video");
  videoElem.setAttribute("playsinline", true);
  videoElem.style.width = "100%";
  videoElem.style.height = "100%";
  document.getElementById("scanner-container").appendChild(videoElem);
  videoElem.addEventListener("click", captureFrame);

  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const camera = devices.find(d => d.kind === "videoinput" && /back|environment/i.test(d.label));
    await navigator.mediaDevices.getUserMedia({
      video: { deviceId: camera ? camera.deviceId : undefined, facingMode: "environment" }
    }).then(stream => videoElem.srcObject = stream);
    await videoElem.play();
  } catch (e) {
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï", "error");
    stopScanner();
  }
}

async function captureFrame() {
  if (scanning) return;
  scanning = true;
  document.getElementById("beep").play();

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = videoElem.videoWidth;
  canvas.height = videoElem.videoHeight;
  const region = { x: canvas.width * 0.25, y: canvas.height * 0.25, w: canvas.width * 0.5, h: canvas.height * 0.5 };
  ctx.drawImage(videoElem, region.x, region.y, region.w, region.h, 0, 0, region.w, region.h);
  const imgData = canvas.toDataURL("image/png");

  const confirm = await Swal.fire({
    title: "‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö QR Code",
    html: `<img src="${imgData}" style="width:90%;border-radius:10px;margin-top:10px;"><p style="margin-top:10px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô QR ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>`,
    showCancelButton: true,
    confirmButtonText: "‚úÖ ‡∏≠‡πà‡∏≤‡∏ô QR",
    cancelButtonText: "‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    allowOutsideClick: false
  });

  if (confirm.isConfirmed) {
    const result = await decodeQR(canvas);
    if (result) {
      stopScanner();
      handleQRData(result);
    } else {
      Swal.fire("‚ö†Ô∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö QR ‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢", "warning");
      scanning = false;
    }
  } else scanning = false;
}

async function decodeQR(canvas) {
  try {
    const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
    const result = new ZXing.MultiFormatReader().decode(binaryBitmap);
    return result.text.trim();
  } catch {
    return null;
  }
}

function stopScanner() {
  if (videoElem && videoElem.srcObject) videoElem.srcObject.getTracks().forEach(t => t.stop());
  document.getElementById("scanner-container").innerHTML = "";
  document.getElementById("scanner-view").style.display = "none";
  document.getElementById("main-view").style.display = "block";
  scanning = false;
}

function handleQRData(text) {
  const parts = text.split("/");
  customer.value = parts[0] || "";
  scannerName.value = parts[1] || "";
  file.value = parts[2] || "";
  lot.value = parts[3] || "";
  rack.value = parts[4] || "";
  sumQty.value = parts[5] || "";
}

function addRackSet() {
  const zone = document.getElementById("rackZone");
  const newSet = document.createElement("div");
  newSet.className = "rack-set";
  newSet.innerHTML = `
    <hr style="margin:10px 0;">
    <div class="form-row"><label>Act Rack</label><input class="actRack" placeholder="‡πÄ‡∏ä‡πà‡∏ô R01-A"></div>
    <div class="compact-row">
      <div>
        <label>Package</label>
        <div class="package-box">
          <input type="number" class="pkg-input a"> √ó
          <input type="number" class="pkg-input b"> +
          <input type="number" class="pkg-input c">
        </div>
      </div>
      <div>
        <label>Act Q'ty</label>
        <input class="actQty readonly" readonly>
      </div>
    </div>
  `;
  zone.appendChild(newSet);

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  newSet.querySelectorAll(".pkg-input").forEach(input => {
    input.addEventListener("input", () => {
      const a = +newSet.querySelector(".pkg-input.a").value || 0;
      const b = +newSet.querySelector(".pkg-input.b").value || 0;
      const c = +newSet.querySelector(".pkg-input.c").value || 0;
      newSet.querySelector(".actQty").value = (a * b) + c;
    });
  });
}

async function submitData() {
  const rackSets = document.querySelectorAll(".rack-set");
  const dataList = [];

  rackSets.forEach(set => {
    const actRack = set.querySelector(".actRack").value.trim();
    const actQty = set.querySelector(".actQty").value.trim();
    dataList.push({ actRack, actQty });
  });

  const payload = {
    customer: customer.value,
    file: file.value,
    lot: lot.value,
    rack: rack.value,
    sumQty: sumQty.value,
    scanner: scannerName.value,
    details: dataList
  };

  if (!payload.customer || !payload.file || !payload.lot)
    return Swal.fire("‚ö†Ô∏è","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏Å‡πà‡∏≠‡∏ô","warning");

  Swal.fire({title:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  try {
    await fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec",{
      method:"POST",
      body:JSON.stringify(payload)
    });
    Swal.close();
    Swal.fire("‚úÖ","‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","success");
  } catch {
    Swal.fire("‚ùå","‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå","error");
  }
}
</script>
</body>
</html>
