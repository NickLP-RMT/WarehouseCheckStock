<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã Warehouse Check (V3.3 Mobile Optimized)</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root {
  --pkg-a: 38px;
  --pkg-b: 38px;
  --pkg-c: 38px;
}
body {
  font-family: 'Inter', sans-serif;
  background: #f1f5f9;
  color: #1e293b;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
}
.container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.header-bar {
  background: linear-gradient(90deg, #2563eb, #1d4ed8);
  color: white;
  text-align: center;
  padding: 12px;
  border-radius: 14px 14px 0 0;
  margin: -24px -24px 20px -24px;
}
.header-bar h3 { margin: 0; font-weight: 600; font-size: 17px; }

label { font-weight: 600; font-size: 13.5px; }
input, select {
  width: 100%;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  font-size: 14px;
  height: 42px;
  padding: 0 10px;
  box-sizing: border-box;
}
input[readonly] { background: #f8fafc; }

button {
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-weight: 600;
  cursor: pointer;
}
.btn-primary { background: #2563eb; color: white; font-size: 14px; }
.btn-add { background: #10b981; color: white; font-size: 20px; }
.btn-delete {
  position: absolute;
  top: 0; right: 0;
  background: #ef4444; color: white;
  border-radius: 0 8px 0 8px;
  padding: 4px 10px;
  font-weight: bold;
  cursor: pointer;
}

.name-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
.name-row select { flex: 1; height: 42px; }
.name-row button { flex: 0 0 110px; height: 42px; }

.row2col { display: flex; gap: 12px; flex-wrap: wrap; }
.col { flex: 1; min-width: 120px; }

.rack-set {
  position: relative;
  border: 1.5px solid #e2e8f0;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 15px;
  background: #f9fafb;
}

.package-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  gap: 10px;
  flex-wrap: nowrap;
  margin-top: 10px;
}
.package-box { flex: 0 0 70%; display: flex; flex-direction: column; }
.actQty-box { flex: 0 0 30%; display: flex; flex-direction: column; }

.package-inputs {
  display: flex;
  align-items: center;
  gap: 6px;
}
.pkg-input {
  text-align: center;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  height: 42px;
  font-size: 14px;
}
.pkg-input.a { width: var(--pkg-a); }
.pkg-input.b { width: var(--pkg-b); }
.pkg-input.c { width: var(--pkg-c); }

.package-inputs span { font-weight: 600; }
.footer { text-align: center; margin-top: 20px; font-size: 12px; color: #94a3b8; }

/* üì± Responsive Mode */
@media (max-width: 480px) {
  body { padding: 10px; }
  .container { padding: 16px; border-radius: 10px; }
  input, select, button { height: 46px; font-size: 15px; }
  .btn-primary { font-size: 15px; }
  .btn-add { font-size: 22px; height: 46px; }
  label { font-size: 14px; }
  .package-row { flex-direction: column; }
  .package-box, .actQty-box { flex: 1 1 100%; }
}
  .btn-edit {
  position: absolute;
  top: 0; right: 44px;
  background: #3b82f6;
  color: white;
  border-radius: 0 8px 0 8px;
  padding: 4px 10px;
  font-weight: bold;
  cursor: pointer;
}

</style>
</head>

<body>
<div class="container">
  <div class="header-bar"><h3>üìã Warehouse Check (V3.3)</h3></div>

  <div class="name-row">
    <div style="flex:1;">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label>
      <select id="nameSelect"></select>
    </div>
    <button class="btn-primary" onclick="fetchItems()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </div>

  <div id="itemSection" style="display:none;">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
    <select id="itemSelect" onchange="showDetail()"></select>

    <div class="row2col" style="margin-top:10px;">
      <div class="col"><label>Customer</label><input id="customer" readonly></div>
      <div class="col"><label>File</label><input id="file5digit" readonly></div>
    </div>
    <div class="row2col">
      <div class="col"><label>Lot</label><input id="lot" readonly></div>
      <div class="col"><label>Q'ty</label><input id="sumQty" readonly></div>
    </div>

    <label>Rack</label><input id="rack" readonly>

    <div id="rackZone">
      <div class="rack-set">
        <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
        <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">‚úèÔ∏è</button>
        <label>Act Rack</label>
        <div class="row2col">
          <div class="col">
            <select class="rackGroup" onchange="updateRackSub(this)">
              <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
          <div class="col"><select class="rackSub"></select></div>
        </div>

        <div style="margin-top:10px;">
          <label>Act Lot</label>
          <input type="text" class="actLotInput">
        </div>

        <div class="package-row">
          <div class="package-box">
            <label>Package</label>
            <div class="package-inputs">
              <input type="number" inputmode="numeric" class="pkg-input a" oninput="calcActQty(this)">
              <span>√ó</span>
              <input type="number" inputmode="numeric" class="pkg-input b" oninput="calcActQty(this)">
              <span>+</span>
              <input type="number" inputmode="numeric" class="pkg-input c" oninput="calcActQty(this)">
            </div>
          </div>
          <div class="actQty-box">
            <label>Act Q'ty</label>
            <input class="actQty" readonly>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn-add" onclick="addRackSet()">Ôºã</button>
      <button class="btn-primary" style="flex:1;" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
  <div class="footer">¬© 2025 Resonac Materials (Thailand) Co., Ltd.</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwYV_cHqxPEA_cxjeYpVjKahzuU8tVyKLk6fD0mUrD8Rbs1_hsmJstWDkzLkRQKSSbp/exec";
let currentItems = [];

// üß© Rack Map
const rackMap = {
  A:["A-A1","A-A2","A-A3","A-A4","A-A5","A-A6","A-A7","A-A8",
     "A-B1","A-B2","A-B3","A-B4","A-B5","A-B6","A-B7","A-B8",
     "A-C1","A-C2","A-C3","A-C4","A-C5","A-C6","A-C7","A-C8",
     "A-D1","A-D2","A-D3","A-D4","A-D5","A-D6","A-D7","A-D8"],
  B:Array.from({length:28},(_,i)=>["B-A","B-B","B-C","B-D"].flatMap(p=>`${p}${i+1}`)).flat(),
  C:Array.from({length:36},(_,i)=>["C-A","C-B","C-C","C-D"].flatMap(p=>`${p}${i+1}`)).flat(),
  D:["D-A1","D-A2","D-A3","D-A4","D-A5","D-A6","D-A7","D-A8","D-A9","D-A10","D-A11","D-A12","D-A13","D-A14","D-A15","D-A16","D-A17","D-A18","D-A19","D-A20","D-A21","D-A22",
     "D-B1","D-B2","D-B3","D-B4","D-B5","D-B6","D-B7","D-B8","D-B9","D-B10","D-B11","D-B12","D-B13","D-B14","D-B15","D-B16","D-B17","D-B18","D-B19","D-B20","D-B21","D-B22"]
};

async function loadNames() {
  Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  try {
    const res = await fetch(`${scriptURL}?page=getNames`);
    const data = await res.json();
    nameSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥ --</option>' + data.map(n => `<option>${n}</option>`).join('');
    Swal.close();
  } catch {
    Swal.fire("‚ùå", "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}
loadNames();

async function fetchItems() {
  const name = nameSelect.value;
  if (!name) return Swal.fire("‚ö†Ô∏è","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥","warning");
  Swal.fire({title:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=${encodeURIComponent(name)}`);
    const rows = await res.json(); Swal.close();
    if(!rows||rows.length===0)return Swal.fire("‚ÑπÔ∏è","‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ","info");
    currentItems=rows; renderDropdown(rows); itemSection.style.display="block"; showDetail();
  } catch { Swal.fire("‚ùå","‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ","error"); }
}

function renderDropdown(rows) {
  let html = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ File No. --</option>`;
  html += rows.map(r => {
    const done = r.Act_Qty && r.Act_Qty !== "" ? "‚úÖ" : "‚ö™Ô∏è";
    const value = `${r.File5digit}|${r.Lot}`;
    return `<option value="${value}">${done} ${r.File5digit} (${r.Lot})</option>`;
  }).join('');
  itemSelect.innerHTML = html;
  itemSelect.selectedIndex = 0;
}

function showDetail() {
  try {
    const value = itemSelect.value;

    // üßπ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ default (-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ File No. --) ‚Üí ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (!value) {
      customer.value = "";
      file5digit.value = "";
      lot.value = "";
      sumQty.value = "";
      rack.value = "";
      document.getElementById("rackZone").innerHTML = `
        <div class="rack-set">
          <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
          <button class="btn-edit" data-editing="false" onclick="toggleEdit(this)">‚úèÔ∏è</button>
          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)">
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div class="col"><select class="rackSub"></select></div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input type="text" class="actLotInput">
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
                <input type="number" inputmode="numeric" class="pkg-input a" oninput="calcActQty(this)">
                <span>√ó</span>
                <input type="number" inputmode="numeric" class="pkg-input b" oninput="calcActQty(this)">
                <span>+</span>
                <input type="number" inputmode="numeric" class="pkg-input c" oninput="calcActQty(this)">
              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly>
            </div>
          </div>
        </div>`;
      return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢
    }

    // üß† ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å File ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    const [fileCode, lotCode] = value.split('|');
    if (!fileCode || !lotCode) return;

    const row = currentItems.find(r => {
      const keys = Object.keys(r);
      const fileKey = keys.find(k => k.trim().toLowerCase() === "file5digit");
      const lotKey  = keys.find(k => k.trim().toLowerCase() === "lot");
      return (r[fileKey]+"").trim()===fileCode.trim() && (r[lotKey]+"").trim()===lotCode.trim();
    });
    if (!row) return Swal.fire("‚ö†Ô∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", "warning");
    const getVal = key => {
      const found = Object.keys(row).find(k => k.trim().toLowerCase() === key.toLowerCase());
      return found ? row[found] : "";
    };
    customer.value=getVal("Customer");
    file5digit.value=getVal("File5digit");
    lot.value=getVal("Lot");
    rack.value=getVal("Rack");
    sumQty.value=getVal("Sum of Qty") || getVal("SumOfQty") || "";

    const actRack=getVal("Act_Rack")||"";
    const rawActLot = getVal("Act_Lot");     // ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡∏à‡∏£‡∏¥‡∏á
    const actLot = rawActLot || getVal("Lot") || "";
    const actLotReadOnly = rawActLot ? "readonly" : ""; // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡πá‡∏≠‡∏Å
    const actPkg=getVal("Act_Package")||"";
    const actQty=getVal("Act_Qty")||"";

    document.getElementById("rackZone").innerHTML=`
      <div class="rack-set">
        <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
        <button class="btn-edit" data-editing="false" onclick="toggleEdit(this)">‚úèÔ∏è</button>

        <label>Act Rack</label>
        <div class="row2col">
          <div class="col">
            <select class="rackGroup" onchange="updateRackSub(this)" ${actRack?'disabled':''}>
              <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
              <option value="A" ${actRack.startsWith("A")?'selected':''}>A</option>
              <option value="B" ${actRack.startsWith("B")?'selected':''}>B</option>
              <option value="C" ${actRack.startsWith("C")?'selected':''}>C</option>
              <option value="D" ${actRack.startsWith("D")?'selected':''}>D</option>
            </select>
          </div>
          <div class="col"><select class="rackSub" ${actRack?'disabled':''}>
            ${actRack?`<option value="${actRack}" selected>${actRack}</option>`:""}
          </select></div>
        </div>

        <div style="margin-top:10px;">
          <label>Act Lot</label>
          <input type="text" class="actLotInput" value="${actLot}" ${actLotReadOnly}>
        </div>

        <div class="package-row">
          <div class="package-box">
            <label>Package</label>
            <div class="package-inputs">
              <input type="number" class="pkg-input a" oninput="calcActQty(this)" ${actPkg?'readonly':''} value="${actPkg.split('√ó')[0]||''}">
              <span>√ó</span>
              <input type="number" class="pkg-input b" oninput="calcActQty(this)" ${actPkg?'readonly':''} value="${(actPkg.split('√ó')[1]||'').split('+')[0]||''}">
              <span>+</span>
              <input type="number" class="pkg-input c" oninput="calcActQty(this)" ${actPkg?'readonly':''} value="${(actPkg.split('+')[1]||'')}">
            </div>
          </div>
          <div class="actQty-box">
            <label>Act Q'ty</label>
            <input class="actQty" readonly value="${actQty}">
          </div>
        </div>
      </div>`;
  } catch (err) {
    console.error("‚ùå showDetail error:", err);
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
  }
}

function updateRackSub(select){
  const subSelect=select.closest(".rack-set").querySelector(".rackSub");
  const group=select.value;
  subSelect.innerHTML=group?rackMap[group].map(v=>`<option value="${v}">${v}</option>`).join(''):'';
}
function calcActQty(input){
  const p=input.closest(".rack-set");
  const a=+p.querySelector(".pkg-input.a").value||0;
  const b=+p.querySelector(".pkg-input.b").value||0;
  const c=+p.querySelector(".pkg-input.c").value||0;
  p.querySelector(".actQty").value=(a*b)+c;
}

function addRackSet(){
  const zone=document.getElementById("rackZone");
  const template=document.querySelector(".rack-set");
  const newSet=template.cloneNode(true);
  newSet.querySelectorAll("input").forEach(i=>i.value="");
  newSet.querySelectorAll("select").forEach(s=>{
    if(s.classList.contains("rackSub"))s.innerHTML="";
    else s.value="";
  });
  newSet.querySelector(".actLotInput").value=document.getElementById("lot").value||"";
  zone.appendChild(newSet);
  setTimeout(()=>newSet.querySelector(".pkg-input.a").focus(),150);
}
function removeRackSet(btn){btn.closest(".rack-set").remove();}

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö toggleEdit: ‡πÅ‡∏Ñ‡πà‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
function toggleEdit(btn){
  const rack=btn.closest(".rack-set");
  const isLocked=btn.dataset.editing==="false";
  btn.dataset.editing=isLocked?"true":"false";
  btn.textContent=isLocked?"üîí":"‚úèÔ∏è";
  btn.style.background=isLocked?"#10b981":"#3b82f6";

  rack.querySelectorAll("input").forEach(el=>{
    if(el.classList.contains("actQty"))return;
    el.readOnly=!isLocked;
  });
  rack.querySelectorAll("select").forEach(el=>el.disabled=!isLocked);
}

async function saveData() {
  const name = nameSelect.value;
  const file = file5digit.value.trim();
  const itemValue = itemSelect.value;
  const sets = document.querySelectorAll(".rack-set");

  // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à
  if (!itemValue) {
    return Swal.fire({
      icon: "warning",
      title: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
    });
  }

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ï‡πà‡∏•‡∏∞ rack-set ‡∏Å‡πà‡∏≠‡∏ô
  for (const s of sets) {
    const group = s.querySelector(".rackGroup").value.trim();
    const sub = s.querySelector(".rackSub").value.trim();
    const actRack = group && sub ? sub : "";
    const actLot = s.querySelector(".actLotInput").value.trim();
    let a = s.querySelector(".pkg-input.a").value.trim();
    let b = s.querySelector(".pkg-input.b").value.trim();
    let c = s.querySelector(".pkg-input.c").value.trim();
    const actQty = s.querySelector(".actQty").value.trim();

    if (c === "") c = "0"; // ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á + ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

    // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á
    if (!actRack || !a || !b || !actLot || !actQty) {
      return Swal.fire({
        icon: "warning",
        title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á",
        text: "(‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á +)",
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
        allowOutsideClick: false
      });
    }

    // ‚ùå ‡∏ñ‡πâ‡∏≤ Act Q'ty <= 0
    if (parseInt(actQty) <= 0) {
      return Swal.fire({
        icon: "warning",
        title: "Act Q'ty ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0",
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
        allowOutsideClick: false
      });
    }
  }

  // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?",
    text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });

  if (!confirm.isConfirmed) return;

  // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  for (const s of sets) {
    const group = s.querySelector(".rackGroup").value.trim();
    const sub = s.querySelector(".rackSub").value.trim();
    const actRack = group && sub ? sub : "";
    const actLot = s.querySelector(".actLotInput").value.trim();
    let a = s.querySelector(".pkg-input.a").value.trim();
    let b = s.querySelector(".pkg-input.b").value.trim();
    let c = s.querySelector(".pkg-input.c").value.trim();
    const actQty = s.querySelector(".actQty").value.trim();
    if (c === "") c = "0";

    const actPackage = `${a}√ó${b}+${c}`;

    await fetch(`${scriptURL}?page=updateRecord`, {
      method: "POST",
      body: new URLSearchParams({
        name,
        file5digit: file,
        lot: lot.value,
        actRack,
        actLot,
        actQty,
        actPackage
      })
    });
  }

  Swal.close();

  await Swal.fire({
    icon: "success",
    title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
    confirmButtonText: "OK"
  });

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });
  clearForm();
  await fetchItems();
}

function clearForm(){
  document.querySelectorAll("input").forEach(el=>{
    if(!el.readOnly)el.value="";
  });
  document.querySelectorAll(".rackGroup,.rackSub").forEach(s=>s.value="");
  document.querySelectorAll(".actQty").forEach(q=>q.value="");
  itemSelect.value="";
  document.getElementById("itemSection").style.display="none";
}
</script>

</body>
</html>
