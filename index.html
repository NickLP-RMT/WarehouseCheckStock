<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RMT Warehouse Check Stock</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { overflow-x: hidden; }
    .sidebar {
      width: 260px;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 56px;
      background: #1e293b;
      color: white;
      padding: 20px;
    }
    .content {
      margin-left: 260px;
      padding: 80px 30px;
      background: #f8fafc;
      min-height: 100vh;
    }
    .sidebar h5 { color: #cbd5e1; margin-top: 20px; }
    .btn-upload { width: 100%; margin-bottom: 20px; }
    .table-container { max-height: 600px; overflow-y: auto; background: white; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; }
    th { background: #e2e8f0; }
    .pagination { justify-content: center; margin-top: 10px; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h4">üì¶ RMT Warehouse Check Stock</span>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>üì§ Zone 1: Upload</h5>
    <input type="file" id="fileInput" class="form-control mb-2" accept=".csv,.xlsx" />
    <button class="btn btn-success btn-upload" onclick="uploadFile()">Upload File</button>

    <h5>üîç Zone 2: Search</h5>
    <label>Start Date</label>
    <input type="date" id="startDate" class="form-control mb-2">
    <label>End Date</label>
    <input type="date" id="endDate" class="form-control mb-2">
    <button class="btn btn-primary w-100" onclick="searchData()">Search</button>
    <button class="btn btn-outline-success w-100 mt-2" onclick="downloadExcel()">Download Excel</button>
  </div>

  <!-- Main Content -->
  <div class="content">
    <h4>üìä Search Results</h4>
    <div class="table-container mt-3">
      <table class="table table-striped" id="dataTable">
        <thead><tr id="tableHeader"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <nav><ul class="pagination" id="pagination"></ul></nav>
  </div>

<script>
let allData = [];
let currentPage = 1;
const rowsPerPage = 10;

async function searchData() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end) {
    Swal.fire("‚ö†Ô∏è Please select start and end date");
    return;
  }

  Swal.fire({ title: "Fetching data...", didOpen: () => Swal.showLoading() });

  // üëâ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets Web App (‡πÅ‡∏Å‡πâ URL ‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  const url = `https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?page=search&start=${start}&end=${end}`;
  const res = await fetch(url);
  const json = await res.json();
  allData = json.data || [];

  Swal.close();
  renderTable();
}

function renderTable(page = 1) {
  currentPage = page;
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = allData.slice(start, end);

  const headerRow = document.getElementById("tableHeader");
  const body = document.getElementById("tableBody");
  body.innerHTML = "";
  headerRow.innerHTML = "";

  if (pageData.length === 0) {
    body.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>No data found</td></tr>";
    return;
  }

  Object.keys(pageData[0]).forEach(col => {
    headerRow.innerHTML += `<th>${col}</th>`;
  });

  pageData.forEach(row => {
    const tr = document.createElement("tr");
    Object.values(row).forEach(val => {
      tr.innerHTML += `<td>${val}</td>`;
    });
    body.appendChild(tr);
  });

  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(allData.length / rowsPerPage);
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    const li = document.createElement("li");
    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
    li.innerHTML = `<a class='page-link' href='#' onclick='renderTable(${i})'>${i}</a>`;
    pagination.appendChild(li);
  }
}

function downloadExcel() {
  if (allData.length === 0) {
    Swal.fire("‚ö†Ô∏è No data to export");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(allData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "SearchData");
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  saveAs(new Blob([wbout], {type:"application/octet-stream"}), `RMT_SearchData_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function uploadFile() {
  const fileInput = document.getElementById("fileInput");
  if (!fileInput.files[0]) {
    Swal.fire("‚ö†Ô∏è Please select a file first!");
    return;
  }
  Swal.fire("‚úÖ File uploaded successfully!");
}
</script>

</body>
</html>
