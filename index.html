<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMT Warehouse Stock Manager (Earth Tone)</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ------------------- Color Palette (Earth Tone) ------------------- */
    :root {
        --color-sage-medium: #ccd5ae; /* Sidebar BG */
        --color-sage-light: #e9edc9; /* Menu Active/Collapse BG */
        --color-cream: #faedcd; /* Navbar/Card BG */
        --color-off-white: #fefae0; /* Body BG */
        --color-terracotta: #d4a373; /* Primary/Accent/Buttons */
        --color-text-dark: #4b3f33; /* Dark Brown Text */
        --color-text-muted: #73695d; /* Muted Brown Text */
        --color-success-dark: #809664; /* A contrasting Green for Success */
    }

    /* Global Styles */
    body {
      overflow-x: hidden;
      background-color: var(--color-off-white);
      font-family: 'Inter', sans-serif;
      color: var(--color-text-dark);
    }
    .text-primary { color: var(--color-terracotta) !important; }

    /* Navbar - Light and Creamy */
    .navbar {
      background: var(--color-cream);
      color: var(--color-text-dark);
      border-bottom: 1px solid var(--color-sage-light);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      height: 56px;
    }
    .navbar-brand { font-weight: 700; color: var(--color-text-dark) !important; }
    .navbar-time { font-size: 14px; color: var(--color-text-muted); font-weight: 500; }

    /* Sidebar - Soft Sage Green */
    .sidebar {
      width: 240px; /* Reduced width */
      height: 100vh;
      position: fixed;
      left: 0;
      top: 56px;
      background: var(--color-sage-medium);
      color: var(--color-text-dark);
      padding: 10px;
      overflow-y: auto;
      transition: all 0.3s ease;
      z-index: 1020;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--color-text-dark);
      width: 100%;
      text-align: left;
      font-size: 15px;
      padding: 12px 10px;
      border-radius: 8px;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      transition: all 0.2s;
    }
    .menu-btn i { margin-right: 8px; font-size: 18px; color: var(--color-terracotta); }
    .menu-btn:hover, .menu-btn.active {
      background-color: var(--color-sage-light);
      color: var(--color-text-dark);
    }
    .collapse-content {
      background-color: var(--color-sage-light);
      border-radius: 8px;
      padding: 15px;
      margin: 5px 0 15px 0;
    }
    .collapse-content .form-label { color: var(--color-text-muted); }

    /* Main Content */
    .content {
      margin-left: 240px; /* Adjusted margin */
      padding: 80px 40px 30px 40px;
      transition: all 0.3s ease;
    }

    /* Input & Button Styling */
    .form-control { border-radius: 6px; border-color: #e0e0e0; background-color: white; }
    .btn { border-radius: 6px; font-weight: 600; }
    .btn-primary { 
        --bs-btn-bg: var(--color-terracotta);
        --bs-btn-border-color: var(--color-terracotta);
        --bs-btn-hover-bg: #c08e5f;
        --bs-btn-hover-border-color: #c08e5f;
        --bs-btn-color: #ffffff;
    }
    .btn-success {
        --bs-btn-bg: var(--color-success-dark);
        --bs-btn-border-color: var(--color-success-dark);
        --bs-btn-hover-bg: #6e8258;
        --bs-btn-hover-border-color: #6e8258;
    }
    /* Adjusted btn-outline-primary and btn-danger for better Earth Tone fit */
    .btn-outline-primary {
        --bs-btn-color: var(--color-terracotta);
        --bs-btn-border-color: var(--color-terracotta);
        --bs-btn-hover-bg: var(--color-terracotta);
        --bs-btn-hover-color: #ffffff;
    }
    .btn-danger {
        --bs-btn-bg: #c85040; /* A slightly darker red for contrast */
        --bs-btn-border-color: #c85040;
    }

    /* Card Layout (for Content Areas) */
    .card-content {
        background-color: var(--color-cream);
        border: 1px solid #e0d9c4;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* QR Code Display */
    .qr-grid {
      /* Using CSS Grid for a better, more responsive layout */
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      padding: 15px 0 0 0;
    }
    .qr-item {
      text-align: center;
      background: var(--color-off-white);
      border-radius: 8px;
      padding: 15px 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    .qr-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .qr-item div:first-child { margin: 0 auto; }

    /* Progress Bar */
    .progress { 
        height: 25px; margin-top: 15px; display: none; border-radius: 6px; 
        background-color: #f0e0d0; /* Soft background */
    }
    .progress-bar.bg-info { background-color: var(--color-terracotta) !important; }
    .progress-bar.bg-success { background-color: var(--color-success-dark) !important; }

    /* Table Styling */
    .table thead th {
        background-color: var(--color-sage-light);
        color: var(--color-text-dark);
        font-weight: 600;
        border-bottom: 2px solid var(--color-sage-medium);
    }
    .table tbody tr:hover { background-color: var(--color-off-white); }
    .table-responsive { margin-top: 10px; }


    /* Media Query for smaller screens (Mobile Responsiveness) */
    @media (max-width: 768px) {
        .sidebar { width: 100%; top: 0; height: auto; position: relative; }
        .content { margin-left: 0; padding: 20px; padding-top: 76px; }
        .navbar { z-index: 1030; }
    }
  </style>
</head>
<body>
  <nav class="navbar fixed-top px-3 d-flex justify-content-between align-items-center">
    <span class="navbar-brand h4 mb-0"><i class="bi bi-box-seam-fill"></i> RMT Stock Manager</span>
    <div class="navbar-time" id="currentDateTime">--/--/---- --:--:--</div>
  </nav>

  <div class="sidebar">
    <button class="menu-btn active" id="import-menu-btn" data-bs-toggle="collapse" data-bs-target="#importSection" aria-expanded="true">
        <i class="bi bi-cloud-arrow-up-fill"></i> Import & Generate QR
    </button>
    <div class="collapse collapse-content show" id="importSection">
      <label class="form-label small">Select Excel/CSV File</label>
      <input type="file" id="fileInput" class="form-control mb-3" accept=".xlsx,.csv">
      <button class="btn btn-primary w-100 mb-3" onclick="handleFile()">
        <i class="bi bi-qr-code-scan"></i> Generate QR
      </button>
      <div class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%">0%</div>
      </div>
      <hr class="text-muted">
      <button class="btn btn-outline-primary w-100 mt-2" id="downloadBtn" onclick="downloadPDF()" disabled>
        <i class="bi bi-file-earmark-pdf-fill"></i> Download PDF
      </button>
      <button class="btn btn-danger w-100 mt-2" id="clearBtn" onclick="clearAll()" disabled>
        <i class="bi bi-x-octagon-fill"></i> Clear All
      </button>
    </div>

    <button class="menu-btn" id="search-menu-btn" data-bs-toggle="collapse" data-bs-target="#searchSection" aria-expanded="false">
        <i class="bi bi-search"></i> Search Stock Data
    </button>
    <div class="collapse collapse-content" id="searchSection">
      <label for="startDate" class="form-label small">Start Date</label>
      <input type="date" id="startDate" class="form-control mb-2">
      <label for="endDate" class="form-label small">End Date</label>
      <input type="date" id="endDate" class="form-control mb-3">
      <button class="btn btn-success w-100 mb-2" onclick="searchData()">
        <i class="bi bi-funnel-fill"></i> Search
      </button>
      <button class="btn btn-outline-success w-100" onclick="exportExcel()">
        <i class="bi bi-file-earmark-excel-fill"></i> Export Excel
      </button>
    </div>
  </div>

  <div class="content">
    <div id="contentImport">
      <h3 class="mb-4 text-primary"><i class="bi bi-qr-code"></i> QR Code Generation</h3>
      <div class="card-content">
          <h5 class="card-title text-muted mb-3">üßæ Preview Generated QR Codes</h5>
          <div id="qrContainer" class="qr-grid">
              <p class="text-center text-muted m-0 p-5">Upload an Excel file to see the generated QR codes here.</p>
          </div>
      </div>
    </div>

    <div id="contentSearch" style="display:none;">
      <h3 class="mb-4 text-primary"><i class="bi bi-table"></i> Search Results</h3>
      <div class="card-content">
          <h5 class="card-title text-muted mb-3">üîç Stock Transaction History</h5>
          <div class="table-responsive">
              <table class="table table-striped table-hover mt-3">
                <thead><tr><th>#</th><th>Date</th><th>Item</th><th>Qty</th></tr></thead>
                <tbody id="searchTableBody">
                    <tr><td colspan="4" class="text-center text-muted">No data found. Please run a search.</td></tr>
                </tbody>
              </table>
          </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // üïí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    function updateDateTime() {
        const now = new Date();
        const formatted = now.toLocaleString('th-TH', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
        document.getElementById('currentDateTime').textContent = formatted;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // üîπ Toggle content logic (Updated to use active class for menu buttons)
    const importCollapse = document.getElementById('importSection');
    const searchCollapse = document.getElementById('searchSection');
    const importContent = document.getElementById('contentImport');
    const searchContent = document.getElementById('contentSearch');
    const importBtn = document.getElementById('import-menu-btn');
    const searchBtn = document.getElementById('search-menu-btn');

    importCollapse.addEventListener('show.bs.collapse', () => {
        searchContent.style.display = 'none';
        importContent.style.display = 'block';
        searchBtn.classList.remove('active');
        importBtn.classList.add('active');
        if (searchCollapse.classList.contains('show')) {
            new bootstrap.Collapse(searchCollapse, { toggle: false }).hide();
        }
    });

    searchCollapse.addEventListener('show.bs.collapse', () => {
        importContent.style.display = 'none';
        searchContent.style.display = 'block';
        importBtn.classList.remove('active');
        searchBtn.classList.add('active');
        if (importCollapse.classList.contains('show')) {
            new bootstrap.Collapse(importCollapse, { toggle: false }).hide();
        }
    });

    // Set initial active state
    if (importCollapse.classList.contains('show')) {
        importBtn.classList.add('active');
    } else if (searchCollapse.classList.contains('show')) {
        searchBtn.classList.add('active');
    }

    // ---------- Mock Search / Export (Kept original logic) ----------
    function searchData() {
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;
        if (!start || !end) {
            Swal.fire("‚ö†Ô∏è", "Please select start and end date", "warning");
            return;
        }

        const tbody = document.getElementById("searchTableBody");
        tbody.innerHTML = "";
        const mockData = [
            { date: "2025-10-14", item: "Speaker A", qty: 2 },
            { date: "2025-10-15", item: "Speaker B", qty: 1 },
            { date: "2025-10-16", item: "Projector", qty: 3 },
            { date: "2025-10-17", item: "Cable Set", qty: 10 }
        ];

        mockData.forEach((d, i) => {
            tbody.innerHTML += `<tr><td>${i + 1}</td><td>${d.date}</td><td>${d.item}</td><td>${d.qty}</td></tr>`;
        });
        
        if (mockData.length === 0) {
             tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data found for the selected period.</td></tr>';
        }

        Swal.fire("‚úÖ", "Search complete!", "success");
    }

    function exportExcel() {
        Swal.fire("üì§", "Exporting search data to Excel...", "info");
    }

    // ---------------- QR Generate / PDF / Clear (Kept original logic) ----------------
    const { jsPDF } = window.jspdf;
    let qrDataList = [];

    function handleFile() {
        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files[0]) {
            Swal.fire("‚ö†Ô∏è", "Please select an Excel or CSV file first!", "warning");
            return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            generateQRs(jsonData);
        };
        reader.readAsArrayBuffer(file);
    }

    async function generateQRs(data) {
        const container = document.getElementById("qrContainer");
        const progressBar = document.getElementById("progressBar");
        const progressContainer = document.querySelector(".progress");
        container.innerHTML = "";
        qrDataList = [];

        if (data.length <= 1) {
            Swal.fire("‚ö†Ô∏è", "No data found in file", "warning");
            container.innerHTML = '<p class="text-center text-muted m-0 p-5">No data found in the file. Please check the content.</p>';
            return;
        }

        progressContainer.style.display = "flex"; // Use flex for better progress bar alignment
        progressBar.style.width = "0%";
        progressBar.innerText = "0%";
        progressBar.classList.remove("bg-success");
        progressBar.classList.add("bg-info");

        for (let i = 1; i < data.length; i++) {
            const row = data[i].filter(cell => cell !== undefined && cell !== "");
            if (row.length === 0) continue;
            const text = row.join("/");
            const qrDiv = document.createElement("div");
            qrDiv.className = "qr-item";
            
            // Wrapper for QR code to control size/centering
            const qrCanvasWrapper = document.createElement("div");
            qrCanvasWrapper.style.width = "130px"; 
            qrCanvasWrapper.style.height = "130px";
            qrDiv.appendChild(qrCanvasWrapper);

            const label = document.createElement("div");
            label.innerText = text;
            label.style.fontSize = "10px";
            label.style.marginTop = "8px";
            label.style.fontWeight = "600";
            qrDiv.appendChild(label);
            container.appendChild(qrDiv);
            
            // Set QR color (dark brown)
            new QRCode(qrCanvasWrapper, { text: text, width: 130, height: 130, colorDark : "#4b3f33", colorLight : "#fefae0" });
            
            qrDataList.push({ text, element: qrDiv });
            const percent = Math.round((i / (data.length - 1)) * 100);
            progressBar.style.width = percent + "%";
            progressBar.innerText = percent + "%";
            await new Promise(r => setTimeout(r, 5)); // Slight delay for progress bar effect
        }

        Swal.fire("‚úÖ", `Generated ${qrDataList.length} QR Codes successfully!`, "success");
        progressBar.classList.remove("bg-info");
        progressBar.classList.add("bg-success");
        document.getElementById("downloadBtn").disabled = false;
        document.getElementById("clearBtn").disabled = false;
    }

    function downloadPDF() {
        if (qrDataList.length === 0) return;
        
        const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        const marginX = 8, marginY = 18, qrSize = 24, colCount = 6, rowCount = 7;
        const gapX = 6, gapY = 5, labelYOffset = 4, stepY = qrSize + 10;
        let x = marginX, y = marginY, col = 0, row = 0, counter = 1;
        let headerName = "";
        try { headerName = qrDataList[0].text.split("/")[1] || ""; } catch (e) {}
        const printHeader = () => {
            pdf.setFontSize(10);
            pdf.setTextColor(75, 63, 51); // Dark Brown Text for PDF header
            const today = new Date().toISOString().split("T")[0];
            const headerText = `RMT Warehouse QR List ‚Äî ${headerName} (${today})`;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const textWidth = pdf.getTextWidth(headerText);
            pdf.text(headerText, (pageWidth - textWidth) / 2, 10);
            pdf.setTextColor(0);
        };
        printHeader();

        for (let i = 0; i < qrDataList.length; i++) {
            const canvas = qrDataList[i].element.querySelector("div > canvas"); 
            if (!canvas) continue;

            const qrText = qrDataList[i].text;
            const parts = qrText.split("/");
            const filtered = parts.filter((_, idx) => idx !== 1);
            const label = filtered.join(" ").trim();
            const imgData = canvas.toDataURL("image/png");
            
            // Set light border color
            pdf.setDrawColor(228, 220, 203); 
            pdf.rect(x - 1, y - 1, qrSize + 2, qrSize + 10, "S");
            
            pdf.setFontSize(7);
            pdf.text(`${counter}`, x - 0.5, y - 2.5);
            pdf.addImage(imgData, "PNG", x, y, qrSize, qrSize);
            
            pdf.setFontSize(6);
            pdf.text(pdf.splitTextToSize(label, qrSize), x, y + qrSize + labelYOffset);
            
            col++; counter++;
            if (col === colCount) { col = 0; x = marginX; row++; y += stepY + gapY; }
            else x += qrSize + gapX;
            
            if (row === rowCount && i < qrDataList.length - 1) {
                pdf.addPage(); printHeader(); x = marginX; y = marginY; row = 0; col = 0;
            }
        }
        pdf.save(`RMT_QRCodes_${headerName}_${new Date().toISOString().split("T")[0]}.pdf`);
    }

    function clearAll() {
        document.getElementById("qrContainer").innerHTML = '<p class="text-center text-muted m-0 p-5">Upload an Excel file to see the generated QR codes here.</p>';
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("progressBar").innerText = "0%";
        document.getElementById("progressBar").classList.remove("bg-success");
        document.getElementById("progressBar").classList.add("bg-info");
        document.querySelector(".progress").style.display = "none";
        document.getElementById("downloadBtn").disabled = true;
        document.getElementById("clearBtn").disabled = true;
        document.getElementById("fileInput").value = null; // Clear file input
        qrDataList = [];
        Swal.fire("üßπ", "All QR Codes cleared!", "info");
    }
  </script>
</body>
</html>
