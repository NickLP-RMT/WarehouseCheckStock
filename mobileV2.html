<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã Warehouse Check (Mobile V2.1)</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  color: #1e293b; padding: 20px; min-height: 100vh;
}
.container {
  max-width: 460px; margin: 0 auto; background: white;
  padding: 24px; border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
label { font-weight: 600; margin-top: 10px; }
input, select {
  width: 100%; padding: 8px;
  border-radius: 6px; border: 1.5px solid #cbd5e1;
}
button {
  margin-top: 15px; padding: 10px;
  border: none; border-radius: 8px;
  font-weight: 600; cursor: pointer; width: 100%;
}
.btn-primary { background: #2563eb; color: white; }
.btn-success { background: #059669; color: white; }
.btn-secondary { background: #6b7280; color: white; }
.footer {
  text-align: center; margin-top: 20px;
  font-size: 12px; color: #94a3b8;
}
</style>
</head>
<body>
<div class="container">
  <h3>üìã Warehouse Check (V2.1)</h3>

  <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label>
  <select id="nameSelect"></select>
  <button class="btn-primary" onclick="fetchItems()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

  <div id="itemSection" style="display:none;">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
    <select id="itemSelect" onchange="showDetail()"></select>

    <label>Customer</label>
    <input id="customer" readonly>

    <label>File5digit</label>
    <input id="file5digit" readonly>

    <label>Lot</label>
    <input id="lot" readonly>

    <label>Rack</label>
    <input id="rack" readonly>

    <label>Sum of Qty</label>
    <input id="sumQty" readonly>

    <!-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö: Act_Package ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô -->
    <label>Act_Package</label>
    <input id="actPackage" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20√ó24+0" oninput="calcActQty()">

    <label>Act_Qty</label>
    <input id="actQty" readonly placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">

    <label>Act_Rack</label>
    <input id="actRack" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Rack ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á">

    <button class="btn-success" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="btn-secondary" onclick="resetForm()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div class="footer">
    ¬© 2025 Resonac Materials (Thailand) Co., Ltd.
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbx17uBD3jJO2wpVgYiSdc7shdthNMKrUXx4qxD3Fie8NV5w26uxE5l_7Kn9nZDdQn8g/exec";
let currentItems = [];

// üß≠ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥
async function loadNames() {
  try {
    const res = await fetch(`${scriptURL}?page=getNames`);
    const data = await res.json();
    const select = document.getElementById("nameSelect");
    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥ --</option>' + data.map(n => `<option>${n}</option>`).join('');
  } catch {
    Swal.fire("‚ùå", "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}
loadNames();

// üîç ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
async function fetchItems() {
  const name = document.getElementById("nameSelect").value;
  if (!name) return Swal.fire("‚ö†Ô∏è", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥", "warning");

  Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=${encodeURIComponent(name)}`);
    const rows = await res.json();
    Swal.close();

    if (!rows || rows.length === 0) return Swal.fire("‚ÑπÔ∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ", "info");

    currentItems = rows;
    const itemSelect = document.getElementById("itemSelect");
    itemSelect.innerHTML = rows.map(r => `<option value="${r.File5digit}">${r.File5digit} (${r.Lot})</option>`).join('');
    document.getElementById("itemSection").style.display = "block";
    showDetail();
  } catch {
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
  }
}

// üìã ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function showDetail() {
  const file = document.getElementById("itemSelect").value;
  const row = currentItems.find(r => r.File5digit === file);
  if (!row) return;
  customer.value = row.Customer || "";
  file5digit.value = row.File5digit || "";
  lot.value = row.Lot || "";
  rack.value = row.Rack || "";
  sumQty.value = row["Sum of Qty"] || "";
  actPackage.value = row.Act_Package || "";
  actQty.value = row.Act_Qty || "";
  actRack.value = row.Act_Rack || "";
}

// üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Act_Qty ‡∏à‡∏≤‡∏Å Act_Package
function calcActQty() {
  const input = document.getElementById("actPackage").value.trim();
  const output = document.getElementById("actQty");

  if (!input) { output.value = ""; return; }

  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏ä‡πà‡∏ô 20√ó24+3 ‡∏´‡∏£‡∏∑‡∏≠ 20x24+3
  const pattern = /^(\d+)[x√ó](\d+)(?:\+(\d+))?$/i;
  const match = input.match(pattern);

  if (match) {
    const a = parseInt(match[1]);
    const b = parseInt(match[2]);
    const c = match[3] ? parseInt(match[3]) : 0;
    output.value = (a * b) + c;
  } else {
    output.value = "";
  }
}

// üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function saveData() {
  const name = nameSelect.value;
  const file = file5digit.value;
  const actRack = actRackInput.value;
  const actQty = actQtyInput.value;
  const actPackage = actPackageInput.value;

  const actRackInput = document.getElementById("actRack");
  const actQtyInput = document.getElementById("actQty");
  const actPackageInput = document.getElementById("actPackage");

  if (!name || !file || !actPackageInput.value) {
    Swal.fire("‚ö†Ô∏è", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "warning");
    return;
  }

  Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const res = await fetch(`${scriptURL}?page=updateRecord`, {
      method: "POST",
      body: new URLSearchParams({
        name,
        file5digit: file,
        actRack: actRackInput.value,
        actQty: actQtyInput.value,
        actPackage: actPackageInput.value
      })
    });
    const json = await res.json();
    Swal.fire(json.success ? "‚úÖ" : "‚ùå", json.message, json.success ? "success" : "error");
    if (json.success) resetForm();
  } catch {
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
  }
}

// üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
function resetForm() {
  document.getElementById("itemSection").style.display = "none";
  document.getElementById("nameSelect").value = "";
  currentItems = [];
}
</script>
</body>
</html>
