<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã FG Inventory data check</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
:root {
  --pkg-a: 65px;
  --pkg-b: 65px;
  --pkg-c: 65px;
}

body {
  font-family: 'Inter', sans-serif;
  background: #f1f5f9;
  color: #1e293b;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
}

.container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.header-bar {
  background: linear-gradient(90deg, #2563eb, #1d4ed8);
  color: white;
  text-align: center;
  padding: 12px;
  border-radius: 14px 14px 0 0;
  margin: -24px -24px 20px -24px;
}

.header-bar h3 {
  margin: 0;
  font-weight: 600;
  font-size: 17px;
}

label {
  font-weight: 600;
  font-size: 13.5px;
}

input, select {
  width: 100%;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  font-size: 14px;
  height: 42px;
  padding: 0 10px;
  box-sizing: border-box;
  transition: background-color 0.2s ease, color 0.2s ease;
}

input[readonly], select:disabled {
  background-color: #f1f5f9 !important;
  color: #6b7280;
  cursor: not-allowed;
}

input.editable, select.editable {
  background-color: #ffffff !important;
  color: #1e293b;
  cursor: text;
}

button {
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-weight: 600;
  cursor: pointer;
}

.btn-primary {
  background: #2563eb;
  color: white;
  font-size: 14px;
}

.btn-add {
  background: #10b981;
  color: white;
  font-size: 20px;
}

.name-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
  flex-wrap: wrap;
}

.name-row select {
  flex: 1;
  height: 42px;
}

.name-row button {
  flex: 0 0 110px;
  height: 42px;
}

.row2col {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.col {
  flex: 1;
  min-width: 120px;
}

.rack-set {
  border: 1.5px solid #d1d5db;
  border-radius: 12px;
  padding: 14px;
  margin-top: 10px;
  margin-bottom: 15px;
  background: linear-gradient(180deg, #ecfdf5 0%, #d1fae5 100%);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.rack-set:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
}

.set-title {
  font-size: 14px;
  font-weight: 700;
  color: #065f46;
  margin-bottom: 8px;
}

.action-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  margin-top: -4px;
}

.btn-edit,
.btn-delete {
  border-radius: 6px;
  padding: 6px 10px;
  font-weight: bold;
  color: white;
  cursor: pointer;
  border: none;
}

.btn-edit {
  background: #3b82f6;
}

.btn-delete {
  background: #ef4444;
}

.package-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  gap: 10px;
  flex-wrap: nowrap;
  margin-top: 10px;
}

.package-box {
  flex: 0 0 70%;
  display: flex;
  flex-direction: column;
}

.actQty-box {
  flex: 0 0 30%;
  display: flex;
  flex-direction: column;
}

.package-inputs {
  display: flex;
  align-items: center;
  gap: 6px;
}

.pkg-input {
  text-align: center;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  height: 42px;
  font-size: 14px;
}

.pkg-input.a { width: var(--pkg-a); }
.pkg-input.b { width: var(--pkg-b); }
.pkg-input.c { width: var(--pkg-c); }

.package-inputs span {
  font-weight: 600;
}

.footer {
  text-align: center;
  margin-top: 20px;
  font-size: 12px;
  color: #94a3b8;
}

/* üì± Responsive */
@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  .container {
    padding: 16px;
    border-radius: 10px;
  }
  input, select, button {
    height: 46px;
    font-size: 15px;
  }
  .btn-primary {
    font-size: 15px;
  }
  .btn-add {
    font-size: 22px;
    height: 46px;
  }
  label {
    font-size: 14px;
  }
  .package-row {
    flex-direction: column;
  }
  .package-box,
  .actQty-box {
    flex: 1 1 100%;
  }
}
</style>
</head>

<body>
<div class="container">
  <div class="header-bar"><h3>üìã FG Inventory data check</h3></div>

  <div class="name-row">
    <div style="flex:1;">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label>
      <select id="nameSelect"></select>
    </div>
    <button class="btn-primary" onclick="fetchItems()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </div>

  <div id="itemSection" style="display:none;">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
    <select id="customerSelect" onchange="filterItemsByCustomer()"></select>

    <label style="margin-top:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
    <select id="itemSelect" onchange="showDetail()"></select>

    <div class="row2col" style="margin-top:10px;">
      <div class="col">
        <label>Customer</label>
        <input id="customer" readonly>
      </div>
      <div class="col">
        <label>File</label>
        <input id="file5digit" readonly>
      </div>
    </div>

    <div class="row2col">
      <div class="col">
        <label>Lot</label>
        <input id="lot" readonly>
      </div>
      <div class="col">
        <label>Q'ty</label>
        <input id="sumQty" readonly>
      </div>
    </div>

    <label>Rack</label>
    <input id="rack" readonly>

    <div id="rackZone">
      <div class="rack-set" data-master="true">
        <div class="set-title">Act Set #1</div>
        <div class="action-buttons">
          <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
          <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
        </div>

        <label>Act Rack</label>
        <div class="row2col">
          <div class="col">
            <select class="rackGroup" onchange="updateRackSub(this)">
              <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="PC AREA">PC AREA</option>
              <option value="BKK AREA">BKK AREA</option>
              <option value="SUBSTORE AREA">SUBSTORE AREA</option>
            </select>
          </div>
          <div class="col">
            <select class="rackSub"></select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Act Lot</label>
          <input type="text" class="actLotInput">
        </div>

        <div class="package-row">
          <div class="package-box">
            <label>Package</label>
            <div class="package-inputs">
              <input type="number" inputmode="numeric" class="pkg-input a" oninput="calcActQty(this)">
              <span>√ó</span>
              <input type="number" inputmode="numeric" class="pkg-input b" oninput="calcActQty(this)">
              <span>+</span>
              <input type="number" inputmode="numeric" class="pkg-input c" oninput="calcActQty(this)">
            </div>
          </div>
          <div class="actQty-box">
            <label>Act Q'ty</label>
            <input class="actQty" readonly>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
<button class="btn-add" type="button" onclick="addRackSet()">Ôºã</button>
      <button class="btn-primary" style="flex:1;" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

  <div class="footer">¬© 2025 Resonac Materials (Thailand) Co., Ltd.</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzTjblFsGLcaenms5lt5-D1jjSzH4pNlzsEJjLCSfCdKRkT78hiw-M3tJ4DMGG7MC0_/exec";
let currentItems = [];

// Rack Map
const rackMap = {
  A: [
    "A-A1","A-A2","A-A3","A-A4","A-A5","A-A6","A-A7","A-A8",
    "A-B1","A-B2","A-B3","A-B4","A-B5","A-B6","A-B7","A-B8",
    "A-C1","A-C2","A-C3","A-C4","A-C5","A-C6","A-C7","A-C8",
    "A-D1","A-D2","A-D3","A-D4","A-D5","A-D6","A-D7","A-D8"
  ],
  B: Array.from({ length: 28 }, (_, i) =>
      ["B-A", "B-B", "B-C", "B-D"].flatMap(p => `${p}${i + 1}`)
    ).flat(),
  C: Array.from({ length: 36 }, (_, i) =>
      ["C-A", "C-B", "C-C", "C-D"].flatMap(p => `${p}${i + 1}`)
    ).flat(),
  D: [
    "D-A1","D-A2","D-A3","D-A4","D-A5","D-A6","D-A7","D-A8",
    "D-A9","D-A10","D-A11","D-A12","D-A13","D-A14","D-A15","D-A16","D-A17","D-A18","D-A19","D-A20","D-A21","D-A22",
    "D-B1","D-B2","D-B3","D-B4","D-B5","D-B6","D-B7","D-B8",
    "D-B9","D-B10","D-B11","D-B12","D-B13","D-B14","D-B15","D-B16","D-B17","D-B18","D-B19","D-B20","D-B21","D-B22"
  ]
};

// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å rack-set ‡∏°‡∏µ set-title + ‡∏à‡∏±‡∏î‡πÇ‡∏´‡∏°‡∏î edit/lock
function refreshRackSets() {
  const sets = document.querySelectorAll(".rack-set");

  sets.forEach((set, idx) => {
    const isMaster = idx === 0;
    set.dataset.master = isMaster ? "true" : "false";

    // set-title
    let title = set.querySelector(".set-title");
    if (!title) {
      title = document.createElement("div");
      title.className = "set-title";
      set.insertBefore(title, set.firstChild);
    }
    title.textContent = `Act Set #${idx + 1}`;

    const editBtn = set.querySelector(".btn-edit");
    const delBtn  = set.querySelector(".btn-delete");

    if (isMaster) {
      // Master: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
      if (delBtn) delBtn.style.display = "none";

      // Master: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏¢
      if (editBtn) {
        editBtn.style.display = "inline-flex";
        editBtn.dataset.editing = "true";
        editBtn.textContent = "üîí";
        editBtn.style.background = "#10b981";
      }

      set.querySelectorAll("input").forEach(el => {
        if (!el.classList.contains("actQty")) {
          el.readOnly = false;
          el.classList.add("editable");
        }
      });
      set.querySelectorAll("select").forEach(el => {
        el.disabled = false;
        el.classList.add("editable");
      });

    } else {
      // Set#2 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î lock
      if (delBtn) delBtn.style.display = "inline-flex";
      if (editBtn) {
        if (!editBtn.dataset.editing) {
          editBtn.dataset.editing = "false";
        }
        const editing = editBtn.dataset.editing === "true";
        editBtn.textContent = editing ? "üîí" : "‚úèÔ∏è";
        editBtn.style.background = editing ? "#10b981" : "#3b82f6";

        set.querySelectorAll("input").forEach(el => {
          if (el.classList.contains("actQty")) return;
          el.readOnly = !editing;
          el.classList.toggle("editable", editing);
        });
        set.querySelectorAll("select").forEach(el => {
          el.disabled = !editing;
          el.classList.toggle("editable", editing);
        });
      }
    }
  });
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥
async function loadNames() {
  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });
  try {
    const res = await fetch(`${scriptURL}?page=getNames`);
    const data = await res.json();
    nameSelect.innerHTML =
      '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥ --</option>' +
      data.map(n => `<option>${n}</option>`).join('');
    Swal.close();
  } catch {
    Swal.fire("‚ùå", "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}

loadNames();
refreshRackSets();

async function fetchItems() {
  const name = nameSelect.value;
  if (!name) {
    return Swal.fire("‚ö†Ô∏è", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥", "warning");
  }

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=${encodeURIComponent(name)}`);
    const rows = await res.json();
    Swal.close();

    if (!rows || rows.length === 0) {
      return Swal.fire("‚ÑπÔ∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ", "info");
    }

    currentItems = rows;
    loadCustomers(rows);
    itemSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>`;
    customerSelect.value = "";
    itemSection.style.display = "block";
  } catch {
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
  }
}

function showDetail() {
  try {
    const value = itemSelect.value;

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí reset ‡πÄ‡∏õ‡πá‡∏ô Act Set #1 ‡∏ß‡πà‡∏≤‡∏á
    if (!value) {
      customer.value = "";
      file5digit.value = "";
      lot.value = "";
      sumQty.value = "";
      rack.value = "";

      document.getElementById("rackZone").innerHTML = `
        <div class="rack-set" data-master="true" data-id="1">
          <div class="set-title">Act Set #1</div>
          <div class="action-buttons">
            <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
            <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
          </div>

          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)">
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="PC AREA">PC AREA</option>
                <option value="BKK AREA">BKK AREA</option>
                <option value="SUBSTORE AREA">SUBSTORE AREA</option>
              </select>
            </div>
            <div class="col"><select class="rackSub"></select></div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input type="text" class="actLotInput">
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
                <input type="text" inputmode="numeric" pattern="[0-9]*"
                       class="pkg-input a" oninput="validateNumber(this); calcActQty(this)">
                <span>√ó</span>
                <input type="text" inputmode="numeric" pattern="[0-9]*"
                       class="pkg-input b" oninput="validateNumber(this); calcActQty(this)">
                <span>+</span>
                <input type="text" inputmode="numeric" pattern="[0-9]*"
                       class="pkg-input c" oninput="validateNumber(this); calcActQty(this)">
              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly>
            </div>
          </div>
        </div>
      `;
      refreshRackSets();
      return;
    }

    // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤ File | Lot | Rack ‡πÄ‡∏î‡∏¥‡∏°
    const [fileCode, lotCode, rackName] = value.split("|");
    if (!fileCode || !lotCode) return;

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà File + Lot + Rack ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
    const selectedRows = currentItems.filter(r => {
      return (
        String(r.File5digit).trim() === fileCode.trim() &&
        String(r.Lot).trim()        === lotCode.trim() &&
        String(r.Rack).replace(/\[.*?\]/g, "").trim() === rackName.trim()
      );
    });

    if (selectedRows.length === 0) {
      return Swal.fire("‚ö†Ô∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", "warning");
    }

    // ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô base
    const base = selectedRows[0];
    const getVal = key => {
      const found = Object.keys(base).find(k => k.trim().toLowerCase() === key.toLowerCase());
      return found ? base[found] : "";
    };

    customer.value = getVal("Customer");
    file5digit.value = getVal("File5digit");
    lot.value = getVal("Lot");
    rack.value = getVal("Rack");
    sumQty.value = getVal("Sum of Qty") || getVal("SumOfQty") || "";

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á rack-set ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let htmlRack = "";
    selectedRows.forEach((row, index) => {
      const rawId = row.ID !== undefined ? row.ID :
                    row.Id !== undefined ? row.Id :
                    row.id;
      const idStr = rawId !== undefined && rawId !== null ? String(rawId) : "";

      const isMaster = idStr === "1";  // ID=1 = master ‡∏ï‡∏≤‡∏° code.gs

      const actRack   = row.Act_Rack    || "";
      const rawActLot = row.Act_Lot;
      const actLotVal = rawActLot || row.Lot || "";
      const actPkg    = row.Act_Package || "";
      const actQty    = row.Act_Qty     || "";

      const pkgA = actPkg ? (actPkg.split("√ó")[0] || "") : "";
      const pkgB = actPkg ? ((actPkg.split("√ó")[1] || "").split("+")[0] || "") : "";
      const pkgC = actPkg ? ((actPkg.split("+")[1] || "") || "") : "";

      htmlRack += `
        <div class="rack-set" data-id="${idStr}" data-master="${isMaster ? "true" : "false"}">
          <div class="set-title">Act Set #${index + 1}</div>

          <div class="action-buttons">
            <button class="btn-edit" data-editing="false" onclick="toggleEdit(this)">‚úèÔ∏è</button>
            ${isMaster ? "" : '<button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>'}
          </div>

          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)" ${actRack ? "disabled" : ""}>
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A" ${actRack.startsWith("A") ? "selected" : ""}>A</option>
                <option value="B" ${actRack.startsWith("B") ? "selected" : ""}>B</option>
                <option value="C" ${actRack.startsWith("C") ? "selected" : ""}>C</option>
                <option value="D" ${actRack.startsWith("D") ? "selected" : ""}>D</option>
                <option value="PC AREA" ${actRack === "PC AREA" ? "selected" : ""}>PC AREA</option>
                <option value="BKK AREA" ${actRack === "BKK AREA" ? "selected" : ""}>BKK AREA</option>
                <option value="SUBSTORE AREA" ${actRack === "SUBSTORE AREA" ? "selected" : ""}>SUBSTORE AREA</option>
              </select>
            </div>
            <div class="col">
              <select class="rackSub" ${actRack ? "disabled" : ""}>
                ${actRack ? `<option value="${actRack}" selected>${actRack}</option>` : ""}
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input type="text" class="actLotInput"
                   value="${actLotVal}" ${rawActLot ? "readonly" : ""}>
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
                <input type="number" class="pkg-input a" oninput="calcActQty(this)"
                       value="${pkgA}" ${actPkg ? "readonly" : ""}>
                <span>√ó</span>
                <input type="number" class="pkg-input b" oninput="calcActQty(this)"
                       value="${pkgB}" ${actPkg ? "readonly" : ""}>
                <span>+</span>
                <input type="number" class="pkg-input c" oninput="calcActQty(this)"
                       value="${pkgC}" ${actPkg ? "readonly" : ""}>
              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly value="${actQty}">
            </div>
          </div>
        </div>
      `;
    });

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ rack-set ‡πÄ‡∏•‡∏¢ ‚Üí ‡∏ó‡∏≥ Act Set #1 ‡∏ß‡πà‡∏≤‡∏á
    if (!htmlRack) {
      htmlRack = `
        <div class="rack-set" data-master="true">
          <div class="set-title">Act Set #1</div>
          <div class="action-buttons">
            <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
          </div>

          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)">
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="PC AREA">PC AREA</option>
                <option value="BKK AREA">BKK AREA</option>
                <option value="SUBSTORE AREA">SUBSTORE AREA</option>
              </select>
            </div>
            <div class="col"><select class="rackSub"></select></div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input class="actLotInput" value="${lotCode}">
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
                <input class="pkg-input a" oninput="calcActQty(this)">
                <span>√ó</span>
                <input class="pkg-input b" oninput="calcActQty(this)">
                <span>+</span>
                <input class="pkg-input c" oninput="calcActQty(this)">
              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly>
            </div>
          </div>
        </div>
      `;
    }

    document.getElementById("rackZone").innerHTML = htmlRack;
    refreshRackSets();

  } catch (err) {
    console.error("showDetail error:", err);
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ", "error");
  }
}

function updateRackSub(select) {
  const subSelect = select.closest(".rack-set").querySelector(".rackSub");
  const group = select.value;

  if (group === "PC AREA" || group === "BKK AREA" || group === "SUBSTORE AREA") {
    subSelect.innerHTML = `<option value="${group}" selected>${group}</option>`;
    return;
  }

  subSelect.innerHTML = group
    ? rackMap[group].map(v => `<option value="${v}">${v}</option>`).join("")
    : "";
}

function calcActQty(input) {
  const p = input.closest(".rack-set");
  const a = +p.querySelector(".pkg-input.a").value || 0;
  const b = +p.querySelector(".pkg-input.b").value || 0;
  const c = +p.querySelector(".pkg-input.c").value || 0;
  p.querySelector(".actQty").value = (a * b) + c;
}

function addRackSet() {
  const zone = document.getElementById("rackZone");

  const newSet = document.createElement("div");
  newSet.className = "rack-set";
  newSet.dataset.master = "false";
  newSet.dataset.id = "new";   // ‚≠ê ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ new ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ code.gs ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà

  newSet.innerHTML = `
    <div class="set-title">Act Set #?</div>
    <div class="action-buttons">
      <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
      <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
    </div>

    <label>Act Rack</label>
    <div class="row2col">
      <div class="col">
        <select class="rackGroup" onchange="updateRackSub(this)">
          <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="PC AREA">PC AREA</option>
          <option value="BKK AREA">BKK AREA</option>
          <option value="SUBSTORE AREA">SUBSTORE AREA</option>
        </select>
      </div>
      <div class="col"><select class="rackSub"></select></div>
    </div>

    <div style="margin-top:10px;">
      <label>Act Lot</label>
      <input type="text" class="actLotInput" value="">
    </div>

    <div class="package-row">
      <div class="package-box">
        <label>Package</label>
        <div class="package-inputs">
          <input class="pkg-input a" oninput="calcActQty(this)">
          <span>√ó</span>
          <input class="pkg-input b" oninput="calcActQty(this)">
          <span>+</span>
          <input class="pkg-input c" oninput="calcActQty(this)">
        </div>
      </div>
      <div class="actQty-box">
        <label>Act Q'ty</label>
        <input class="actQty" readonly>
      </div>
    </div>
  `;

  zone.appendChild(newSet);
  refreshRackSets();
}


async function removeRackSet(btn) {
  const rackSet = btn.closest(".rack-set");
  const isMaster = rackSet.dataset.master === "true";
  if (isMaster) return;

  const actRack = rackSet.querySelector(".rackSub").value.trim();
  const file = file5digit.value.trim();
  const lotVal = lot.value.trim();
  const name = nameSelect.value.trim();
  const originalRack = rack.value.trim();
  const rackId = rackSet.dataset.id;

  if (!actRack || !rackId) {
    rackSet.remove();
    refreshRackSets();
    return;
  }

  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?",
    text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Rack ${actRack} ‡∏Ç‡∏≠‡∏á ${file} (${lotVal}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`,
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡∏•‡∏ö",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });
  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=deleteRecord`, {
      method: "POST",
      body: new URLSearchParams({
        name,
        file5digit: file,
        lot: lotVal,
        originalRack,
        id: rackId
      })
    });

    const result = await res.json();
    Swal.close();

    if (result.success) {
      rackSet.remove();
      refreshRackSets();
      Swal.fire("‚úÖ", "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
    } else {
      Swal.fire("‚ö†Ô∏è", result.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "warning");
    }
  } catch (err) {
    Swal.close();
    Swal.fire("‚ùå", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
    console.error(err);
  }
}

function toggleEdit(btn) {
  const rack = btn.closest(".rack-set");
  const isEditing = btn.dataset.editing !== "true"; // toggle

  btn.dataset.editing = isEditing ? "true" : "false";
  btn.textContent = isEditing ? "üîí" : "‚úèÔ∏è";
  btn.style.background = isEditing ? "#10b981" : "#3b82f6";

  rack.querySelectorAll("input").forEach(el => {
    if (el.classList.contains("actQty")) return;
    el.readOnly = !isEditing;
    el.classList.toggle("editable", isEditing);
  });

  rack.querySelectorAll("select").forEach(el => {
    el.disabled = !isEditing;
    el.classList.toggle("editable", isEditing);
  });
}

async function saveData() {
  const name = nameSelect.value;
  const file = file5digit.value.trim();
  const itemValue = itemSelect.value;
  const sets = document.querySelectorAll(".rack-set");
  const originalRack = rack.value.trim();
  const customerVal = customer.value.trim();
  const sumQtyVal = sumQty.value.trim();

  if (!itemValue) {
    return Swal.fire({
      icon: "warning",
      title: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
    });
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å set ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö + ‡∏°‡∏µ rackId (‡∏ï‡∏≤‡∏° logic ‡∏Ç‡∏≠‡∏á code.gs)
  for (const s of sets) {
    const isMaster = s.dataset.master === "true";
    const group = s.querySelector(".rackGroup").value.trim();
    const sub   = s.querySelector(".rackSub").value.trim();
    let actRack = group && sub ? sub : "";
    const actLot = s.querySelector(".actLotInput").value.trim();
    let a = s.querySelector(".pkg-input.a").value.trim();
    let b = s.querySelector(".pkg-input.b").value.trim();
    let c = s.querySelector(".pkg-input.c").value.trim();
    const actQty = s.querySelector(".actQty").value.trim();
    const rackId = s.dataset.id || "";

    if (isMaster && !actRack) {
      actRack = originalRack;
    }
    if (c === "") c = "0";

    if (!actRack || !a || !b || !actLot || !actQty) {
      return Swal.fire({
        icon: "warning",
        title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á",
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
        allowOutsideClick: false
      });
    }

    if (parseInt(actQty, 10) <= 0) {
      return Swal.fire({
        icon: "warning",
        title: "Act Q'ty ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0",
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
        allowOutsideClick: false
      });
    }
  }

  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?",
    text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });
  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞ rack-set
  for (const s of sets) {
    const isMaster = s.dataset.master === "true";
    const group = s.querySelector(".rackGroup").value.trim();
    const sub   = s.querySelector(".rackSub").value.trim();
    let actRack = group && sub ? sub : "";
    const actLot = s.querySelector(".actLotInput").value.trim();
    let a = s.querySelector(".pkg-input.a").value.trim();
    let b = s.querySelector(".pkg-input.b").value.trim();
    let c = s.querySelector(".pkg-input.c").value.trim();
    const actQty = s.querySelector(".actQty").value.trim();
    const rackId = s.dataset.id || "";

    if (isMaster && !actRack) {
      actRack = originalRack;
    }
    if (c === "") c = "0";

    const actPackage = `${a}√ó${b}+${c}`;

    await fetch(`${scriptURL}?page=updateRecord`, {
      method: "POST",
      body: new URLSearchParams({
        name,
        file5digit: file,
        lot: lot.value,
        originalRack,
        customer: customerVal,
        sumQty: sumQtyVal,
        actRack,
        actLot,
        actQty,
        actPackage,
        rackId
      })
    });
  }

  Swal.close();

  await Swal.fire({
    icon: "success",
    title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
    confirmButtonText: "OK"
  });

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  clearForm();
  await fetchItems();
}

function clearForm() {
  customer.value = "";
  file5digit.value = "";
  lot.value = "";
  sumQty.value = "";
  rack.value = "";
  itemSelect.value = "";

  const zone = document.getElementById("rackZone");
  zone.innerHTML = `
    <div class="rack-set" data-master="true" data-id="1">
      <div class="set-title">Act Set #1</div>
      <div class="action-buttons">
        <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
        <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
      </div>

      <label>Act Rack</label>
      <div class="row2col">
        <div class="col">
          <select class="rackGroup" onchange="updateRackSub(this)">
            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="PC AREA">PC AREA</option>
            <option value="BKK AREA">BKK AREA</option>
            <option value="SUBSTORE AREA">SUBSTORE AREA</option>
          </select>
        </div>
        <div class="col"><select class="rackSub"></select></div>
      </div>

      <div style="margin-top:10px;">
        <label>Act Lot</label>
        <input type="text" class="actLotInput">
      </div>

      <div class="package-row">
        <div class="package-box">
          <label>Package</label>
          <div class="package-inputs">
            <input class="pkg-input a" oninput="calcActQty(this)">
            <span>√ó</span>
            <input class="pkg-input b" oninput="calcActQty(this)">
            <span>+</span>
            <input class="pkg-input c" oninput="calcActQty(this)">
          </div>
        </div>
        <div class="actQty-box">
          <label>Act Q'ty</label>
          <input class="actQty" readonly>
        </div>
      </div>
    </div>
  `;
  document.getElementById("itemSection").style.display = "none";
  refreshRackSets();
}

function validateNumber(el) {
  el.value = el.value.replace(/[^0-9]/g, "");
}

function loadCustomers(rows) {
  const customers = [...new Set(rows.map(r => r.Customer || ""))];

  customerSelect.innerHTML =
    `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>` +
    customers.map(c => `<option value="${c}">${c}</option>`).join("");
}

function filterItemsByCustomer() {
  const customerSel = customerSelect.value;
  const list = document.getElementById("itemSelect");

  customer.value = "";
  file5digit.value = "";
  lot.value = "";
  sumQty.value = "";
  rack.value = "";

  document.getElementById("rackZone").innerHTML = `
    <div class="rack-set" data-master="true" data-id="1">
      <div class="set-title">Act Set #1</div>
      <div class="action-buttons">
        <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
        <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
      </div>

      <label>Act Rack</label>
      <div class="row2col">
        <div class="col">
          <select class="rackGroup" onchange="updateRackSub(this)">
            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="PC AREA">PC AREA</option>
            <option value="BKK AREA">BKK AREA</option>
            <option value="SUBSTORE AREA">SUBSTORE AREA</option>
          </select>
        </div>
        <div class="col"><select class="rackSub"></select></div>
      </div>

      <div style="margin-top:10px;">
        <label>Act Lot</label>
        <input type="text" class="actLotInput">
      </div>

      <div class="package-row">
        <div class="package-box">
          <label>Package</label>
          <div class="package-inputs">
            <input class="pkg-input a" oninput="calcActQty(this)">
            <span>√ó</span>
            <input class="pkg-input b" oninput="calcActQty(this)">
            <span>+</span>
            <input class="pkg-input c" oninput="calcActQty(this)">
          </div>
        </div>
        <div class="actQty-box">
          <label>Act Q'ty</label>
          <input class="actQty" readonly>
        </div>
      </div>
    </div>
  `;
  refreshRackSets();

  list.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>`;
  if (!customerSel) return;

  const rows = currentItems.filter(r => r.Customer === customerSel);

  list.innerHTML += rows
    .map(r => {
      const done = r.Act_Qty ? "‚úÖ" : "‚ö™Ô∏è";
      const cleanRack = (r.Rack || "").replace(/\[.*?\]/g, "").trim();
      return `
        <option value="${r.File5digit}|${r.Lot}|${cleanRack}">
          ${done} ${r.File5digit} (${r.Lot}) [${cleanRack}]
        </option>
      `;
    })
    .join("");
}
</script>
</body>
</html>
