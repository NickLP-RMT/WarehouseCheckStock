<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì¶ FG Inventory data check (Admin)</title>

  <!-- Library -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { overflow-x: hidden; background-color: #f8fafc; }
    .navbar { background: #1e293b; color: white; }
    .navbar-time { font-size: 16px; color: #e2e8f0; font-weight: 500; }

    .sidebar {
      width: 260px; height: 100vh;
      position: fixed; left: 0; top: 56px;
      background: #1e293b; color: white; padding: 15px;
      overflow-y: auto;
    }

    .content { margin-left: 260px; padding: 80px 30px; }
    .progress { height: 22px; display: none; }
    table { font-size: 14px; }

    /* Tabs */
    .nav-tabs { border-bottom: 1px solid #475569; margin-bottom: 15px; }
    .nav-tabs .nav-link { color: #cbd5e1; background: transparent; }
    .nav-tabs .nav-link.active { background:#334155; color:#fff; }
    .nav-tabs .nav-link:hover { background:#475569; color:#fff; }

    .collapse-content {
      background: #243043; border-radius: 8px;
      padding: 10px; margin-bottom: 10px;
    }

    /* Group row */
    .table-group {
      background-color: #dbeafe !important;
      color: #1e3a8a;
      font-weight: 600;
      border-top: 2px solid #93c5fd;
    }

    /* Delta colors */
    .delta-positive { color:#15803d !important; background:#dcfce7 !important; font-weight:600; }
    .delta-negative { color:#b91c1c !important; background:#fee2e2 !important; font-weight:600; }
    .delta-zero     { color:#334155 !important; background:#f1f5f9 !important; font-weight:500; }

    /* Arrow icon */
    .arrow {
      color: #6b7280; font-weight: bold;
      padding-right: 6px;
      display: inline-block;
      width: 12px;
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark fixed-top px-3 d-flex justify-content-between align-items-center">
    <span class="navbar-brand h4 mb-0">üì¶ FG Inventory data check (Admin)</span>
    <div class="navbar-time" id="currentDateTime">--/--/---- --:--:--</div>
  </nav>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul class="nav nav-tabs nav-justified">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#searchTab">üîç Search</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#uploadTab">üì§ Upload</button></li>
    </ul>

    <div class="tab-content">

      <!-- SEARCH TAB -->
      <div class="tab-pane fade show active" id="searchTab">
        <div class="collapse-content">

          <label>Start Date</label>
          <input type="date" id="startDate" class="form-control mb-2">

          <label>End Date</label>
          <input type="date" id="endDate" class="form-control mb-3">

          <label>Customer</label>
          <input type="text" id="searchCustomer" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô KKFT">

          <label>File5digit</label>
          <input type="text" id="searchFile5" class="form-control mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô F0576">

          <label>Lot</label>
          <input type="text" id="searchLot" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô 23100280">

          <button class="btn btn-primary w-100 mb-2" onclick="searchData()">Search</button>
          <button class="btn btn-secondary w-100 mb-2" onclick="clearFilters()">Clear Filter</button>
          <button class="btn btn-outline-success w-100" onclick="exportExcel()">Export Excel</button>

        </div>
      </div>

      <!-- UPLOAD TAB -->
      <div class="tab-pane fade" id="uploadTab">
        <div class="collapse-content">

          <input type="file" id="fileInput" class="form-control mb-3" accept=".xlsx,.csv">
          <button class="btn btn-success w-100 mb-2" onclick="uploadToSheet()">Upload to Database</button>

          <div class="progress mt-2">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info">0%</div>
          </div>

          <button class="btn btn-danger w-100 mt-3" onclick="deleteAll()">üóë Delete Data from Database</button>

        </div>
      </div>

    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <h4>üìä Data Result</h4>
    <div id="resultText" class="mt-3 text-secondary">Please upload Excel file or search data...</div>

    <div class="table-responsive mt-3">
      <table class="table table-striped">
        <thead class="table-dark"><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>


<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<!-- ========================= -->
<!--  JAVASCRIPT (FULL CLEAN) -->
<!-- ========================= -->
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzSBnEJ9EfGjmPCXuUS5-rFHWBU79DPGsUSdSpk0O5vnbmUxEKEAeNVOvoAad2v8wDn/exec";
let allData = [];

/* -------------------------------
   ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
--------------------------------*/
function convertToBangkokTime(utcString) {
  if (!utcString) return "";
  return new Date(utcString).toLocaleString("th-TH", {
    timeZone: "Asia/Bangkok",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).replace(",", "");
}

function updateDateTime() {
  document.getElementById('currentDateTime').textContent =
    new Date().toLocaleString('th-TH', {
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    });
}
setInterval(updateDateTime, 1000); updateDateTime();


/* -------------------------------
   Upload Excel
--------------------------------*/
async function uploadToSheet() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return Swal.fire("‚ö†Ô∏è", "Please select a file!", "warning");

  const bar = document.getElementById("progressBar");
  document.querySelector(".progress").style.display = "block";
  bar.style.width = "0%"; bar.innerText = "0%";

  Swal.fire({ title: "Uploading...", didOpen: () => Swal.showLoading() });

  const reader = new FileReader();
  reader.onload = async e => {
    const workbook = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header:1, blankrows:true, defval:"" });

    /* 1) Validate columns */
    for (let i=0;i<rows.length;i++){
      if (rows[i].filter(x=>x!=="").length>6){
        return Swal.fire("‚ùå Error","‡πÅ‡∏ñ‡∏ß "+(i+1)+" ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏Å‡∏¥‡∏ô 6","error");
      }
    }

    /* 2) Validate header */
    const header = ["Customer","Name","File5digit","Lot","Rack","SumOfQty"];
    if (header.some((h,i)=>rows[0][i]?.trim()!==h)){
      return Swal.fire("‚ö†Ô∏è Header ‡∏ú‡∏¥‡∏î","‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô: " + header.join(" | "),"warning");
    }

    /* 3) Build payload */
    const payload = rows.slice(1).map(r=>({
      Customer:r[0], Name:r[1], File5digit:r[2],
      Lot:r[3], Rack:r[4], SumOfQty:r[5]
    }));

    try {
      await fetch(`${scriptURL}?page=uploadData`, { method:"POST", body:JSON.stringify(payload) });
      Swal.fire("‚úÖ", "Upload ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      bar.style.width="100%"; bar.innerText="100%"; bar.classList.replace("bg-info","bg-success");

    } catch(err){
      Swal.fire("‚ùå Error","Upload Failed","error");
    }
  };

  reader.readAsArrayBuffer(file);
}


/* -------------------------------
   Delete All
--------------------------------*/
async function deleteAll(){
  const ok = await Swal.fire({
    title:"‚ö†Ô∏è Delete All?",
    text:"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö",
    icon:"warning",
    showCancelButton:true,
    confirmButtonText:"Delete"
  });
  if (!ok.isConfirmed) return;

  Swal.fire({ title:"Deleting...", didOpen:()=>Swal.showLoading() });

  try {
    const res = await fetch(`${scriptURL}?page=deleteAll`,{method:"POST"});
    const json = await res.json();
    Swal.fire("‚úÖ",json.message,"success");
  } catch {
    Swal.fire("‚ùå Error","Cannot delete","error");
  }
}


/* -------------------------------
   Search Data
--------------------------------*/
async function searchData(){
  Swal.fire({title:"Searching...",didOpen:()=>Swal.showLoading()});

  const s = document.getElementById("startDate").value;
  const e = document.getElementById("endDate").value;
  const cus = document.getElementById("searchCustomer").value.toLowerCase();
  const f5  = document.getElementById("searchFile5").value.toLowerCase();
  const lot = document.getElementById("searchLot").value.toLowerCase();

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=ALL`);
    const data = await res.json();
    Swal.close();

    const parse = ts => ts ? ts.split(" ")[0].split("/").reverse().join("-") : "";

    const filtered = data.filter(r=>{
      const d=parse(r.Timestamp);
      return (!s||d>=s)&&(!e||d<=e)
        &&(!cus||(r.Customer||"").toLowerCase().includes(cus))
        &&(!f5||(r.File5digit||"").toLowerCase().includes(f5))
        &&(!lot||(r.Lot||"").toLowerCase().includes(lot));
    });

    allData=filtered;
    renderGroupedTable(filtered);

    document.getElementById("resultText").innerHTML =
      filtered.length ?
      `üîé ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <b>${filtered.length}</b> ‡πÅ‡∏ñ‡∏ß` :
      `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;

  } catch(err){
    Swal.fire("‚ùå","Cannot fetch data","error");
  }
}

function clearFilters(){
  ["startDate","endDate","searchCustomer","searchFile5","searchLot"]
    .forEach(id=>document.getElementById(id).value="");
  Swal.fire("üßπ","‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","success");
}


/* -------------------------------
   Rack Normalize
--------------------------------*/
function normalizeRack(r){
  if(!r) return "";
  const m=r.match(/\[(.*?)\]/);
  let c=(m?m[1]:r).trim().replace(/\s+/g,"").toUpperCase();
  return c==="PCCHPAREA"?"PCCHPAREA":c;
}
const displayRack=r=>{
  if(!r) return "";
  const m=r.match(/\[(.*?)\]/);
  let c=(m?m[1]:r).trim();
  return c.replace(/\s+/g,"").toUpperCase()==="PCCHPAREA"?"PCCHPAREA":c;
}
const toNum=v=>Number(String(v||"").replace(/,/g,""))||0;


/* -------------------------------
   Render Table (No Collapse)
--------------------------------*/
function renderGroupedTable(data){
  const head=document.getElementById("tableHead");
  const body=document.getElementById("tableBody");
  body.innerHTML="";

  if(data.length===0){
    head.innerHTML="";
    body.innerHTML=`<tr><td colspan="20" class="text-center text-muted">No data found</td></tr>`;
    return;
  }

  /* Header */
  const headers=Object.keys(data[0]).filter(h=>h!=="ID");
  if(!headers.includes("Delta +/-")){
    headers.splice(headers.indexOf("Act_Package")+1,0,"Delta +/-");
  }
  head.innerHTML=headers.map(h=>`<th>${h}</th>`).join("");

  /* Group By File+Lot */
  const mainGroups={};
  data.forEach(r=>{
    const k=`${r.File5digit}_${r.Lot}`;
    if(!mainGroups[k]) mainGroups[k]=[];
    mainGroups[k].push(r);
  });

  for(const key in mainGroups){
    const group=mainGroups[key];
    const [file,lot]=key.split("_");

    const allEmpty=group.every(r=>!r.Act_Rack&&!r.Act_Lot&&!r.Act_Qty&&!r.Act_Package);

    body.innerHTML+=`
      <tr class="table-group">
        <td colspan="${headers.length}">
          üì¶ <b>${file}</b> / <b>${lot}</b>
          ${allEmpty?" - <span style='color:#b45309;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check</span>":""}
        </td>
      </tr>
    `;

    /* group by Rack */
    const rackGroups={};
    group.forEach(r=>{
      const k=normalizeRack(r.Rack);
      if(!rackGroups[k]) rackGroups[k]=[];
      rackGroups[k].push(r);
    });

    for(const rackNorm in rackGroups){
      const rows=rackGroups[rackNorm].sort((a,b)=>a.ID-b.ID);

      /* Rack Header */
      body.innerHTML+=`
        <tr style="background:#e2e8f0;">
          <td colspan="${headers.length}">
            <span class="arrow">‚ñº</span> Rack: <b>${displayRack(rackNorm)}</b>
          </td>
        </tr>
      `;

      const baseSum=toNum(rows[0]["Sum of Qty"]||rows[0].SumOfQty);
      let totalAct=0;

      rows.forEach((r,i)=>{
        const act=toNum(r.Act_Qty);
        totalAct+=act;

        const delta=i===0?(act-baseSum):act;
        const dClass=delta>0?"delta-positive":delta<0?"delta-negative":"delta-zero";

        const hide=["Customer","Name","File5digit","Lot","Rack","SumOfQty","Sum of Qty"];

        const tds=headers.map(h=>{
          if(i!==0&&hide.includes(h)) return `<td></td>`;
          if(h==="Delta +/-") return `<td class="${dClass}">${delta>0?"‚ñ≤ +"+delta:(delta<0?"‚ñº "+delta:"0")}</td>`;
          if(h==="Timestamp") return `<td>${convertToBangkokTime(r.Timestamp)}</td>`;
          if(h==="Rack") return `<td>${displayRack(r.Rack)}</td>`;
          if(h==="Act_Rack") return `<td>${displayRack(r.Act_Rack)}</td>`;
          return `<td>${r[h]||""}</td>`;
        }).join("");

        body.innerHTML+=`<tr>${tds}</tr>`;
      });

      /* Rack total */
      if(!rows.every(r=>!r.Act_Rack&&!r.Act_Lot&&!r.Act_Qty&&!r.Act_Package)){
        const rt=totalAct-baseSum;
        const cls=rt>0?"delta-positive":rt<0?"delta-negative":"delta-zero";

        body.innerHTML+=`
          <tr style="background:#f8fafc; font-weight:bold;">
            <td colspan="${headers.length-1}" class="text-end">‡∏£‡∏ß‡∏° Rack ‡∏ô‡∏µ‡πâ:</td>
            <td class="${cls}">${rt>0?"‚ñ≤ +"+rt:(rt<0?"‚ñº "+rt:"0")}</td>
          </tr>
        `;
      }
    }
  }
}


/* -------------------------------
   Export Excel
--------------------------------*/
async function exportExcel(){
  if(!allData.length)
    return Swal.fire("‚ÑπÔ∏è","‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å","info");

  const sorted=[...allData].sort((a,b)=>
    a.File5digit.localeCompare(b.File5digit)||
    a.Lot.localeCompare(b.Lot)||
    a.ID-b.ID
  );

  const exportData=[];
  const mainGroups={};

  sorted.forEach(r=>{
    const k=`${r.File5digit}_${r.Lot}`;
    if(!mainGroups[k]) mainGroups[k]=[];
    mainGroups[k].push(r);
  });

  for(const key in mainGroups){
    const grp=mainGroups[key];
    const rackGroups={};

    grp.forEach(r=>{
      const k=normalizeRack(r.Rack);
      if(!rackGroups[k]) rackGroups[k]=[];
      rackGroups[k].push(r);
    });

    for(const rackNorm in rackGroups){
      const rows=rackGroups[rackNorm].sort((a,b)=>a.ID-b.ID);
      const base=toNum(rows[0]["Sum of Qty"]||rows[0].SumOfQty);

      rows.forEach(r=>{
        const act=toNum(r.Act_Qty);
        const diff=r.ID===rows[0].ID?(act-base):act;

        exportData.push({
          Customer:r.Customer||"",
          Name:r.Name||"",
          File5digit:r.File5digit||"",
          Lot:r.Lot||"",
          Rack:displayRack(rackNorm),
          "Sum of Qty":r.ID===rows[0].ID?base:"",
          Act_Rack:displayRack(r.Act_Rack)||"",
          Act_Lot:r.Act_Lot||"",
          Act_Qty:r.Act_Qty||"",
          Act_Package:r.Act_Package||"",
          "Delta +/-":diff>0?`‚ñ≤ +${diff}`:diff<0?`‚ñº ${diff}`:"0",
          Timestamp:r.Timestamp?convertToBangkokTime(r.Timestamp):""
        });
      });
    }
  }

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(wb,ws,"WarehouseData");

  ws["!cols"]=Object.keys(exportData[0]).map(k=>({
    wch:Math.max(k.length,...exportData.map(r=>r[k]?r[k].toString().length:0))+2
  }));

  const now=new Date();
  const fileName=`WarehouseData_${now.toISOString().slice(0,19).replace(/:/g,"")}.xlsx`;

  XLSX.writeFile(wb,fileName);
  Swal.fire("‚úÖ","‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","success");
}
</script>

</body>
</html>
